# Project 2: Visualization of global precipitation and global temperature

```{r}
# if(!require("devtools")) install.packages("devtools")
# devtools::install_github("bwlewis/rthreejs

# require(devtools)
# install_github("Displayr/flipChartBasics", dependencies = NA)
```

```{r}
# CRAN version
install.packages('leaflet')

# Or Github version
if (!require('devtools')) install.packages('devtools')
#devtools::install_github('rstudio/leaflet')
```

```{r}
df_surface_temp <- read.csv('~/Data_Visualization/COMP4010_Project2/data/surfaces_temp.csv')
df_precipitation <- read.csv('~/Data_Visualization/COMP4010_Project2/data/precipitation.csv')
df_precipitation
```

```{r}
# Load and read the GeoJSON data
countries <- st_read("~/Data_Visualization/COMP4010_Project2/data/ne_110m_admin_0_countries.geojson")
```

```{r}
library(sf)
library(leaflet)
library(RColorBrewer)

# Assume df_precipitation is already read and available
column_name <- "X1993.07"

# Merging country data with precipitation data
merged_data <- merge(countries, df_precipitation, by.x = "ISO_A3", by.y = "code")

# Check the head of the merged data to ensure merge was successful
head(merged_data)

# Remove or replace NA values in the precipitation data
merged_data[[column_name]] <- ifelse(is.na(merged_data[[column_name]]), 0, merged_data[[column_name]])

# Creating a color palette
color_pal <- colorQuantile("YlOrRd", merged_data[[column_name]], n = 10)

# Building the map
map <- leaflet(merged_data) %>%
  addProviderTiles(providers$OpenStreetMap) %>%
  addPolygons(fillColor = ~color_pal(get(column_name)),
              fillOpacity = 0.8, 
              color = "white", 
              weight = 0.5,
              popup = ~paste(NAME, ":", get(column_name), "mm")) %>%
  addLegend(pal = color_pal, values = merged_data[[column_name]],
            title = "Precipitation (mm)",
            opacity = 0.7,
            position = "bottomright",
            labFormat = labelFormat(suffix = " mm"))

# Print the map
print(map)

```

```{r}
#install.packages("shiny")
```

```{r}
library(shiny)
library(leaflet)
library(sf)
library(RColorBrewer)

# Define the UI for the application
ui <- fluidPage(
  titlePanel("Interactive Map with Year Slider"),
  sidebarLayout(
    sidebarPanel(
      # Slider input for selecting the year
      sliderInput("yearInput", "Select Year",
                  min = 1901, max = 2020, value = 1901, step = 1),
      width = 3
    ),
    mainPanel(
      leafletOutput("map", width = "100%", height = "800px")
    )
  )
)

# Define server logic required to draw the map
server <- function(input, output) {

  output$map <- renderLeaflet({
    # Dynamic column name based on slider input
    column_name <- paste0("X", input$yearInput, ".07")  # Adjust formatting if necessary

    # Filter and prepare the data
    data_filtered <- df_precipitation[, c("code", column_name)]
    names(data_filtered)[names(data_filtered) == column_name] <- 'value'
    merged_data <- merge(countries, data_filtered, by.x = "ISO_A3", by.y = "code")
    merged_data$value <- as.numeric(as.character(merged_data$value))
    merged_data <- merged_data[!is.na(merged_data$value), ]

    color_pal <- colorQuantile("YlOrRd", merged_data$value, n = 10)

    # Create and return the Leaflet map
    leaflet(merged_data) %>%
      addTiles() %>%
      addPolygons(fillColor = ~color_pal(value),
                  fillOpacity = 0.8,
                  color = "white",
                  weight = 0.5,
                  popup = ~paste(NAME, ":", value, "mm")) %>%
      addLegend(pal = color_pal, values = merged_data$value,
                title = "Precipitation (mm)",
                opacity = 0.7,
                position = "bottomright",
                labFormat = labelFormat(suffix = " mm"))
  })
}

# Run the application 
shinyApp(ui = ui, server = server)

```

```{r}
??globejs
```

```{r}
library(stringr)

df_precipitation_filtered <- df_precipitation[str_detect(df_precipitation$code, '^[A-Za-z]+$'), ]
df_precipitation_filtered <- df_precipitation_filtered[, c('code', 'X1901.07')]
df_precipitation_filtered <- na.omit(df_precipitation_filtered)
names(df_precipitation_filtered)[names(df_precipitation_filtered) == 'X1901.07'] <- 'value'
```

```{r}
dim(df_precipitation_filtered)
```

```{r}
library(globe4r)
world <- create_globe(height = "100vh") %>%
  globe_choropleth(
    coords(
      country = code,
      altitude = value,
      cap_color = value
    ), 
    data = df_precipitation_filtered
  ) %>% 
  scale_choropleth_cap_color() %>%  
  scale_choropleth_altitude(0.06, 0.1) %>%
  show_atmosphere(show = TRUE) %>%
  show_graticules(show = TRUE)

world
```
